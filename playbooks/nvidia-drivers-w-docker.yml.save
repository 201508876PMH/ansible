- name: install nvidia drivers and docker drivers
  hosts: "*"
  tasks:
    - name: "install nvidia driver 470"
      apt:
        name: nvidia-driver-470
        state: present
        update_cache: true
      become: true

    - name: "set distribution"
      shell: 'distribution=$(. /etc/os-release;echo $ID$VERSION_ID)'
      register: command_output01

    - name: "add gpg key"
      ansible.builtin.apt_key
   : 'curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -'
      args:
        warn: no

    - name: "add apt source"
      shell: 'curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list'

    - name: "install nvidia-container-toolkit"
      apt:
        name: nvidia-container-toolkit
        state: present
        update_cache: true
      become: true

    - name: "install nvidia-container-runtime"
      apt:
        name: nvidia-container-runtime
        state: present
        update_cache: true
      become: true

    - name: "install nvidia-docker2"
      apt:
        name: nvidia-docker2
        state: present
        update_cache: true
      become: true

    - debug:
        var: command_output01.stdout_lines
